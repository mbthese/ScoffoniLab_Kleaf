---
title: "Kleaf"
author: "Marion Boisseaux"
date: "2024-11-01"
output: html_document
---

#Library
```{r}
library(readxl)
library(ggplot2)
library(tidyr)
library(dplyr)
library(lme4)
library(ggpubr)
library(devtools)
library(grid) # For textGrob ggarrange plots details
```

#CESE

##Data
```{r}

CESE_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "CESE")

```

##Clean
```{r}
dim(CESE_Kleaf)
#[1] 29 31
 CESE_Kleaf_clean <- CESE_Kleaf %>% 
  filter(Specie == "CESE")
dim(CESE_Kleaf_clean)
#[1] 28 31
CESE_Kleaf_clean2 <- CESE_Kleaf_clean %>% 
  filter(Notes != "cv too high")
dim(CESE_Kleaf_clean2)
#[1]  25 31
```

##FIT 
```{r}
#first look for outliers
#format for fitting for Megan's script
CESE_curve <- CESE_Kleaf_clean2 %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = CESE_curve, file = "result/CESE/CESE_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

CESE_linear <-  read.csv("result/CESE/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CESE_logistic <-  read.csv("result/CESE/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CESE_sigmoidal <-  read.csv("result/CESE/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CESE_exp <-  read.csv("result/CESE/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CESE_exp2 <-  read.csv("result/CESE/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(CESE_linear, CESE_logistic, CESE_sigmoidal, CESE_exp, CESE_exp2)

#best model logistic

CESE_logistic <-  read.csv("result/CESE/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.CESE <- seq(min(CESE_Kleaf_clean2$`Lowest Psileaf (Mpa)`), max(CESE_Kleaf_clean2$`Lowest Psileaf (Mpa)`), length.out = length(CESE_Kleaf_clean2$`Lowest Psileaf (Mpa)`))

y_model.CESE<- CESE_logistic$A.A/(1+((x_seq.CESE/CESE_logistic$C.Xo)^CESE_logistic$B.B))

Psi_leaf_50.cese <- CESE_logistic$C.Xo
#For a logistic function, P50₀ is simply the inflection point of the curve, so C.X0
```

##Plot
```{r}

CESE_Kleaf_clean2$Individual <- as.factor(CESE_Kleaf_clean2$Individual)

CESE.plot <- CESE_Kleaf_clean2 %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
  scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.CESE, y = y_model.CESE), color = 'black', size=2, alpha=0.7)+
  ylim(0,25)+
   geom_vline(xintercept = Psi_leaf_50.cese, linetype = "dashed", color = 'red')
  
CESE.plot
```

probably the point at Kleaf = 60 is too high


#PADI
```{r}

PADI_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "PADI")

```

##Clean
```{r}
dim(PADI_Kleaf)
#[1] 22 31
 PADI_Kleaf_clean <- PADI_Kleaf %>% 
  filter(Specie == "PADI") %>%
   drop_na(`Psileaf_fin (Mpa)`)
dim(PADI_Kleaf_clean)
#[1] 23 31



```

## FIT 
```{r}
#first look for outliers
#format for fitting for Megan's script
PADI_curve <- PADI_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = PADI_curve, file = "result/PADI/PADI_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

PADI_linear <-  read.csv("result/PADI/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PADI_logistic <-  read.csv("result/PADI/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PADI_sigmoidal <-  read.csv("result/PADI/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PADI_exp <-  read.csv("result/PADI/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PADI_exp2 <-  read.csv("result/PADI/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(PADI_linear, PADI_logistic, PADI_sigmoidal, PADI_exp, PADI_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

PADI_exp <-  read.csv("result/PADI/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.PADI <- seq(min(PADI_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(PADI_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(PADI_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.PADI <- PADI_exp$A.A*exp(-PADI_exp$B.B*x_seq.PADI)

# Calculate Ψleaf at 50% loss of Kleaf
Psi_leaf_50.padi <- log(0.5)/(-PADI_exp$B.B)
Psi_leaf_50.padi
```

##plot
```{r}
PADI_Kleaf_clean$Individual <- as.factor(PADI_Kleaf_clean$Individual)
PADI.plot <-PADI_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Individual)+
  geom_point(color ='gray', size= 3, alpha = 0.7)+
  labs(
    x = "Leaf water potential (MPa)",
    y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  )+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.PADI, y = y_model.PADI), color = 'black', size=2, alpha=0.7)+
geom_vline(xintercept = Psi_leaf_50.padi, linetype ="dashed", color = 'red')
#+
 #  annotate(geom='text',x=0.5,y=30,label="y = 86.05 * exp(-9.6 x)",fontface='bold', size=6)
PADI.plot
```


#AVSA

```{r}

AVSA_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "AVSA")

```

##Clean
```{r}
dim(AVSA_Kleaf)
#[1] 22 31
 AVSA_Kleaf_clean <- AVSA_Kleaf %>% 
  filter(Specie == "AVSA") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
dim(AVSA_Kleaf_clean)

```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
    AVSA_curve <- AVSA_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = AVSA_curve, file = "result/AVSA/AVSA_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

AVSA_linear <-  read.csv("result/AVSA/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

AVSA_logistic <-  read.csv("result/AVSA/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

AVSA_sigmoidal <-  read.csv("result/AVSA/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

AVSA_exp <-  read.csv("result/AVSA/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

AVSA_exp2 <-  read.csv("result/AVSA/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(AVSA_linear, AVSA_logistic, AVSA_sigmoidal, AVSA_exp, AVSA_exp2)
choose_model
#best model exponential

AVSA_exp<-  read.csv("result/AVSA/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.AVSA <- seq(min(AVSA_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(AVSA_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(AVSA_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.AVSA <- AVSA_exp$A.A*exp(-AVSA_exp$B.B*x_seq.AVSA)

# Calculate Ψleaf at 50% loss of Kleaf
Psi_leaf_50.AVSA <- log(0.5)/(-AVSA_exp$B.B)
Psi_leaf_50.AVSA
  

```

##plot
```{r}
AVSA_Kleaf_clean$Individual <- as.factor(AVSA_Kleaf_clean$Individual)

AVSA.plot <- AVSA_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
  scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.AVSA, y = y_model.AVSA), color = 'black', size=2, alpha=0.7)+
  ylim(0,25)+
   geom_vline(xintercept = Psi_leaf_50.AVSA, linetype = "dashed", color = 'red')
```

#STDE
steinchisma decipiens
```{r}

STDE_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "STDE")

```

##Clean
```{r}
dim(STDE_Kleaf)
#[1] 22 31
 STDE_Kleaf_clean <- STDE_Kleaf %>% 
  filter(Specie == "STDE") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
dim(STDE_Kleaf_clean)




```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
STDE_curve <- STDE_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = STDE_curve, file = "result/STDE/STDE_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

STDE_linear <-  read.csv("result/STDE/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

STDE_logistic <-  read.csv("result/STDE/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

STDE_sigmoidal <-  read.csv("result/STDE/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

STDE_exp <-  read.csv("result/STDE/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

STDE_exp2 <-  read.csv("result/STDE/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(STDE_linear, STDE_logistic, STDE_sigmoidal, STDE_exp, STDE_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

#best model logistic

STDE_logistic <-  read.csv("result/STDE/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.STDE <- seq(min(STDE_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(STDE_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(STDE_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.STDE <- STDE_logistic$A.A/(1+((x_seq.STDE/STDE_logistic$C.Xo)^STDE_logistic$B.B))

Psi_leaf_50.STDE <- STDE_logistic$C.Xo
#For a logistic function, P50₀ is simply the inflection point of the curve, so C.X0
```


##plot
```{r}
STDE_Kleaf_clean$Individual <- as.factor(STDE_Kleaf_clean$Individual)

STDE.plot <- STDE_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
   scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.STDE, y = y_model.STDE), color = 'black', size=2, alpha=0.7)+
  #ylim(0,25)
   geom_vline(xintercept = Psi_leaf_50.STDE, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)

STDE.plot
```

#DASP

```{r}

DASP_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "DASP")

```

##Clean
```{r}
dim(DASP_Kleaf)
#[1] 22 31
 DASP_Kleaf_clean <- DASP_Kleaf %>% 
  filter(Specie == "DASP") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
dim(DASP_Kleaf_clean)




```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
DASP_curve <- DASP_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = DASP_curve, file = "result/DASP/DASP_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

DASP_linear <-  read.csv("result/DASP/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

DASP_logistic <-  read.csv("result/DASP/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

DASP_sigmoidal <-  read.csv("result/DASP/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

DASP_exp <-  read.csv("result/DASP/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

DASP_exp2 <-  read.csv("result/DASP/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(DASP_linear, DASP_logistic, DASP_sigmoidal, DASP_exp, DASP_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

DASP_exp <-  read.csv("result/DASP/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.DASP <- seq(min(DASP_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(DASP_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(DASP_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.DASP <- DASP_exp$A.A*exp(-DASP_exp$B.B*x_seq.DASP)

# Calculate Ψleaf at 50% loss of Kleaf
Psi_leaf_50.DASP <- log(0.5)/(-DASP_exp$B.B)
Psi_leaf_50.DASP
```

##plot
```{r}
DASP_Kleaf_clean$Individual <- as.factor(DASP_Kleaf_clean$Individual)

DASP.plot <- DASP_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
  scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.DASP, y = y_model.DASP), color = 'black', size=2, alpha=0.7)+
  ylim(0,25)+
   geom_vline(xintercept = Psi_leaf_50.DASP, linetype = "dashed", color = 'red')
```

#CHLA
Chasmanthium latifolium
```{r}

CHLA_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "CHLA")

```

##Clean
```{r}
dim(CHLA_Kleaf)
#[1] 22 31
 CHLA_Kleaf_clean <- CHLA_Kleaf %>% 
  filter(Specie == "CHLA") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
dim(CHLA_Kleaf_clean)

#discard row/individual if values between two initial potentials is greater than 0.1 MPa; column `Psileaf_ini_1 (Mpa)` and column `Psileaf_ini_2 (Mpa)`

CHLA_Kleaf_clean2 <- CHLA_Kleaf_clean %>% 
  filter(is.na(`Psileaf_ini_1 (Mpa)`) | abs(`Psileaf_ini_1 (Mpa)` - `Psileaf_ini_2 (Mpa)`) <= 0.1)
dim(CHLA_Kleaf_clean2)

CHLA_Kleaf_clean <- CHLA_Kleaf_clean2
```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
CHLA_curve <- CHLA_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = CHLA_curve, file = "result/CHLA/CHLA_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

CHLA_linear <-  read.csv("result/CHLA/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CHLA_logistic <-  read.csv("result/CHLA/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CHLA_sigmoidal <-  read.csv("result/CHLA/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CHLA_exp <-  read.csv("result/CHLA/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

CHLA_exp2 <-  read.csv("result/CHLA/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(CHLA_linear, CHLA_logistic, CHLA_sigmoidal, CHLA_exp, CHLA_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

#best model logistic

CHLA_logistic <-  read.csv("result/CHLA/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.CHLA <- seq(min(CHLA_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(CHLA_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(CHLA_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.CHLA <- CHLA_logistic$A.A/(1+((x_seq.CHLA/CHLA_logistic$C.Xo)^CHLA_logistic$B.B))

Psi_leaf_50.CHLA <- CHLA_logistic$C.Xo
#For a logistic function, P50₀ is simply the inflection point of the curve, so C.X0

```


##plot
```{r}
CHLA_Kleaf_clean$Individual <- as.factor(CHLA_Kleaf_clean$Individual)
CHLA_Kleaf_clean$Light <- as.factor(CHLA_Kleaf_clean$Light)

CHLA.plot <- CHLA_Kleaf_clean %>%
 #filter(Date == "11272024") %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
   scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.CHLA, y = y_model.CHLA), color = 'black', size=2, alpha=0.7)+
  #ylim(0,25)
 geom_vline(xintercept = Psi_leaf_50.CHLA, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)

CHLA.plot
```

#ZEMA

```{r}

ZEMA_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "ZEMA")
```


##Clean
```{r}
dim(ZEMA_Kleaf)
#[1] 22 31
 ZEMA_Kleaf_clean <- ZEMA_Kleaf %>% 
  filter(Specie == "ZEMA") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
 
ZEMA_Kleaf_clean <- ZEMA_Kleaf_clean[which(!(ZEMA_Kleaf_clean$Individual == 2 & ZEMA_Kleaf_clean$Leaf == 2)), ]


dim(ZEMA_Kleaf_clean)



```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
ZEMA_curve <- ZEMA_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = ZEMA_curve, file = "result/ZEMA/ZEMA_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

ZEMA_linear <-  read.csv("result/ZEMA/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ZEMA_logistic <-  read.csv("result/ZEMA/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ZEMA_sigmoidal <-  read.csv("result/ZEMA/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ZEMA_exp <-  read.csv("result/ZEMA/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ZEMA_exp2 <-  read.csv("result/ZEMA/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(ZEMA_linear, ZEMA_logistic, ZEMA_sigmoidal, ZEMA_exp, ZEMA_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

ZEMA_exp <-  read.csv("result/ZEMA/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.ZEMA <- seq(min(ZEMA_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(ZEMA_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(ZEMA_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.ZEMA <- ZEMA_exp$A.A*exp(-ZEMA_exp$B.B*x_seq.ZEMA)

# Calculate Ψleaf at 50% loss of Kleaf
Psi_leaf_50.ZEMA <- log(0.5)/(-ZEMA_exp$B.B)
Psi_leaf_50.ZEMA
```


##plot
```{r}
ZEMA_Kleaf_clean$Individual <- as.factor(ZEMA_Kleaf_clean$Individual)
ZEMA_Kleaf_clean$Light <- as.factor(ZEMA_Kleaf_clean$Light)

ZEMA.plot <- ZEMA_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
  scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.ZEMA, y = y_model.ZEMA), color = 'black', size=2, alpha=0.7)+
  ylim(0,25)+
   geom_vline(xintercept = Psi_leaf_50.ZEMA, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)
ZEMA.plot
```

#NAVI
Nassella/Stipa viridula
```{r}

NAVI_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "NAVI")

```

##Clean
```{r}
dim(NAVI_Kleaf)
#[1] 22 31
 NAVI_Kleaf_clean <- NAVI_Kleaf %>% 
  filter(Specie == "NAVI") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
dim(NAVI_Kleaf_clean)

```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
NAVI_curve <- NAVI_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = NAVI_curve, file = "result/NAVI/NAVI_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

NAVI_linear <-  read.csv("result/NAVI/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

NAVI_logistic <-  read.csv("result/NAVI/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

NAVI_sigmoidal <-  read.csv("result/NAVI/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

NAVI_exp <-  read.csv("result/NAVI/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

NAVI_exp2 <-  read.csv("result/NAVI/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(NAVI_linear, NAVI_logistic, NAVI_sigmoidal, NAVI_exp, NAVI_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

#best model logistic

NAVI_logistic <-  read.csv("result/NAVI/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.NAVI <- seq(min(NAVI_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(NAVI_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(NAVI_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.NAVI <- NAVI_logistic$A.A/(1+((x_seq.NAVI/NAVI_logistic$C.Xo)^NAVI_logistic$B.B))

Psi_leaf_50.NAVI <- NAVI_logistic$C.Xo
#For a logistic function, P50₀ is simply the inflection point of the curve, so C.X0
```

##plot
```{r}
NAVI_Kleaf_clean$Individual <- as.factor(NAVI_Kleaf_clean$Individual)
NAVI_Kleaf_clean$Light <- as.factor(NAVI_Kleaf_clean$Light)

NAVI.plot <- NAVI_Kleaf_clean %>%
 #filter(Date == "11272024") %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
   scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.NAVI, y = y_model.NAVI), color = 'black', size=2, alpha=0.7)+
  #ylim(0,25)
   geom_vline(xintercept = Psi_leaf_50.NAVI, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)

NAVI.plot
```


#PABI

```{r}

PABI_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "PABI")

```

##Clean
```{r}
dim(PABI_Kleaf)
#[1] 21 31
 PABI_Kleaf_clean <- PABI_Kleaf %>% 
  filter(Specie == "PABI") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)
dim(PABI_Kleaf_clean)
#[1] 20 31



```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
PABI_curve <- PABI_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = PABI_curve, file = "result/PABI/PABI_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

PABI_linear <-  read.csv("result/PABI/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PABI_logistic <-  read.csv("result/PABI/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PABI_sigmoidal <-  read.csv("result/PABI/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PABI_exp <-  read.csv("result/PABI/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

PABI_exp2 <-  read.csv("result/PABI/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(PABI_linear, PABI_logistic, PABI_sigmoidal, PABI_exp, PABI_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

#best model logistic

PABI_logistic <-  read.csv("result/PABI/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.PABI <- seq(min(PABI_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(PABI_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(PABI_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.PABI <- PABI_logistic$A.A/(1+((x_seq.PABI/PABI_logistic$C.Xo)^PABI_logistic$B.B))

Psi_leaf_50.PABI <- PABI_logistic$C.Xo
#For a logistic function, P50₀ is simply the inflection point of the curve, so C.X0
```


##plot
```{r}
PABI_Kleaf_clean$Individual <- as.factor(PABI_Kleaf_clean$Individual)

PABI.plot <- PABI_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
  scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.PABI, y = y_model.PABI), color = 'black', size=2, alpha=0.7)+
  ylim(0,25)+
   geom_vline(xintercept = Psi_leaf_50.PABI, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)
 
```


#ECCG
Echinochloa crus-galli

```{r}

ECCG_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "ECCG")

```

##Clean
```{r}
dim(ECCG_Kleaf)
#[1] 22 31
 ECCG_Kleaf_clean <- ECCG_Kleaf %>% 
  filter(Specie == "ECCG") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>%
   filter(`Psileaf_fin (Mpa)` != 0.765)
dim(ECCG_Kleaf_clean)

```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
ECCG_curve <- ECCG_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = ECCG_curve, file = "result/ECCG/ECCG_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

ECCG_linear <-  read.csv("result/ECCG/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ECCG_logistic <-  read.csv("result/ECCG/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ECCG_sigmoidal <-  read.csv("result/ECCG/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ECCG_exp <-  read.csv("result/ECCG/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

ECCG_exp2 <-  read.csv("result/ECCG/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(ECCG_linear, ECCG_logistic, ECCG_sigmoidal, ECCG_exp, ECCG_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

#best model exp

ECCG_exp  <- read.csv("result/ECCG/Exponential_fits.csv")  %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.ECCG <- seq(min(ECCG_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(ECCG_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(ECCG_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.ECCG <- ECCG_exp$A.A*exp(-ECCG_exp$B.B*x_seq.ECCG)

# Calculate Ψleaf at 50% loss of Kleaf
Psi_leaf_50.ECCG <- log(0.5)/(-ECCG_exp$B.B)
Psi_leaf_50.ECCG
```

##plot
```{r}
ECCG_Kleaf_clean$Individual <- as.factor(ECCG_Kleaf_clean$Individual)
ECCG_Kleaf_clean$Light <- as.factor(ECCG_Kleaf_clean$Light)

ECCG.plot <- ECCG_Kleaf_clean %>%
 #filter(Date == "11272024") %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
   scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
#geom_line(aes(x = x_seq.ECCG, y = y_model.ECCG), color = 'black', size=2, alpha=0.7)+
  #ylim(0,25)
   geom_vline(xintercept = Psi_leaf_50.ECCG, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)

ECCG.plot
```



#SEIT

```{r}

SEIT_Kleaf <-  read_excel("data/Kleaf_Karli_Marion_CESE.xlsx", sheet = "SEIT")

```

##Clean
```{r}
dim(SEIT_Kleaf)
#[1] 21 31
 SEIT_Kleaf_clean <- SEIT_Kleaf %>% 
  filter(Specie == "SEIT") %>%
   drop_na(`Psileaf_fin (Mpa)`) %>%
   drop_na(`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`)%>%
   filter(`Lowest Psileaf (Mpa)` != 0.090)
dim(SEIT_Kleaf_clean)
#[1] 20 31



```

##FIT
```{r}
#first look for outliers
#format for fitting for Megan's script
SEIT_curve <- SEIT_Kleaf_clean %>%
  filter(Light == ">1000") %>%
  dplyr::select(Specie, `Lowest Psileaf (Mpa)`, `Kleaf Tcorr (mmol m-2 s-1 MPa-1)` ) %>%
  rename(psi = `Lowest Psileaf (Mpa)`) %>%
  rename(gs = `Kleaf Tcorr (mmol m-2 s-1 MPa-1)`) %>% #for the script by Megan
  rename(species = Specie) %>%
  mutate(`data type` = 1) %>%
  relocate(`data type` , .after = species )

write.csv(x = SEIT_curve, file = "result/SEIT/SEIT_curve.csv") #ready for 

#after fitting curve with "Closure Script 2017" and "R function MB 2017"

SEIT_linear <-  read.csv("result/SEIT/Linear_fits.csv") %>%
  mutate(`function` = "linear") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

SEIT_logistic <-  read.csv("result/SEIT/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

SEIT_sigmoidal <-  read.csv("result/SEIT/Sigmoidal_fits.csv") %>%
  mutate(`function` = "sigmoidal") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

SEIT_exp <-  read.csv("result/SEIT/Exponential_fits.csv") %>%
  mutate(`function` = "exp") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

SEIT_exp2 <-  read.csv("result/SEIT/Exponential2_fits.csv") %>%
  mutate(`function` = "exp2") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) %>%
  dplyr::select(`function`, species, rsq, AICcorr)

choose_model <- rbind(SEIT_linear, SEIT_logistic, SEIT_sigmoidal, SEIT_exp, SEIT_exp2)
choose_model 
#best model is the one with the lowest AIC. if models have AIC within 2 points, then we cannot distinguish them. so we look at the highest R2. 

#best model logistic

SEIT_logistic <-  read.csv("result/SEIT/Logistic_fits.csv") %>%
  mutate(`function` = "logistic") %>%
  relocate(`function`, .before = Species) %>%
  dplyr::select(-X) %>%
  rename(species= data.type, Data.type = Species) 

# Create a sequence of x values for the regression line from excel
x_seq.SEIT <- seq(min(SEIT_Kleaf_clean$`Lowest Psileaf (Mpa)`), max(SEIT_Kleaf_clean$`Lowest Psileaf (Mpa)`), length.out = length(SEIT_Kleaf_clean$`Lowest Psileaf (Mpa)`))

y_model.SEIT <- SEIT_logistic$A.A/(1+((x_seq.SEIT/SEIT_logistic$C.Xo)^SEIT_logistic$B.B))

Psi_leaf_50.SEIT <- SEIT_logistic$C.Xo
#For a logistic function, P50₀ is simply the inflection point of the curve, so C.X0
```


##plot
```{r}
SEIT_Kleaf_clean$Individual <- as.factor(SEIT_Kleaf_clean$Individual)

SEIT.plot <- SEIT_Kleaf_clean %>%
  ggplot()+
  aes(x=`Lowest Psileaf (Mpa)`, y=`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`, color=Light)+
  geom_point(size= 3, alpha = 0.7)+
  scale_color_manual(values = c('gray', 'red'))+
  #labs(
   # x = "Leaf water potential (MPa)",
    #y = "Leaf hydraulic conductance (mmol m-2 s-1 MPa-1)"
  #)+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  theme(axis.title.y = element_blank())+
geom_line(aes(x = x_seq.SEIT, y = y_model.SEIT), color = 'black', size=2, alpha=0.7)+
  ylim(0,25)+
   geom_vline(xintercept = Psi_leaf_50.SEIT, linetype = "dashed", color = 'red')
   #annotate(geom='text',x=0.5,y=30,label="y = 37.95 * exp(-3.57 x)",fontface='bold', size=6)
 
```

#all plots
```{r}

Kleaf.plots <- ggarrange(CESE.plot, PADI.plot, AVSA.plot, 
STDE.plot, DASP.plot, CHLA.plot, ZEMA.plot, NAVI.plot, PABI.plot, ECCG.plot, SEIT.plot, nrow=4, ncol=3, labels = c("(a) C. setaceus", "(b) P. dilatatum", "(c) A. sativa", "(d) S. decipiens", "(e) D. spicata", "(f) C. latifolium", "(g) Z. mays ", "(h) N. viridula", "(i) P. bisulcatum", "(j) E. crus-galli", "(k) S. italica"), font.label = list(face="bold.italic"), align = "v", common.legend = T, legend = "bottom")

Kleaf.plots <- annotate_figure(
  Kleaf.plots,
  bottom = text_grob("Leaf water potential (-MPa)", size = 12),
  left =textGrob(expression("Leaf hydraulic conductance"~(mmol~m^{-2}~s^{-1}~MPa^{-1})), gp = gpar(fontsize = 12), rot = 90)) # Rotate text

Kleaf.plots

ggsave(filename = "Kleaf_plots.jpg", plot = Kleaf.plots, path = "result", width = 10, height = 6)
```

#Kmax - first try
using model
```{r}

#no light treatment not yet created
# Calculate kmax (average Kleaf for Psileaf = 0 to -0.3 MPa)
# Select x values between 0 and -0.3 MPa
x_filtered.CESE <- x_seq.CESE[x_seq.CESE <= 0.3 & x_seq.CESE >= 0]
x_filtered.PADI <- x_seq.padi[x_seq.padi <= 0.3 & x_seq.padi >= 0]
x_filtered.AVSA <- x_seq.AVSA[x_seq.AVSA <= 0.3 & x_seq.AVSA >= 0]
x_filtered.DASP <- x_seq.DASP[x_seq.DASP <= 0.3 & x_seq.DASP >= 0]

# do not include when light =0
STDE_Kleaf_no_light <- STDE_Kleaf_clean %>% filter(Light!=0) 

x_seq.STDE.nolight <- seq(
  min(STDE_Kleaf_no_light$`Lowest Psileaf (Mpa)`),
  max(STDE_Kleaf_no_light$`Lowest Psileaf (Mpa)`),
  length.out = nrow(STDE_Kleaf_no_light)
)

x_filtered.STDE <- x_seq.STDE.nolight[x_seq.STDE.nolight <= 0.3 & x_seq.STDE.nolight >= 0]

CHLA_Kleaf_no_light <- CHLA_Kleaf_clean %>% filter(Light!=0) 

x_seq.CHLA.nolight <- seq(
  min(CHLA_Kleaf_no_light$`Lowest Psileaf (Mpa)`),
  max(CHLA_Kleaf_no_light$`Lowest Psileaf (Mpa)`),
  length.out = nrow(CHLA_Kleaf_no_light)
)


x_filtered.CHLA <- x_seq.CHLA.nolight[x_seq.CHLA.nolight <= 0.3 & x_seq.CHLA.nolight >= 0]

ZEMA_Kleaf_no_light <- ZEMA_Kleaf_clean %>% filter(Light!=0) 

x_seq.ZEMA.nolight <- seq(
  min(ZEMA_Kleaf_no_light$`Lowest Psileaf (Mpa)`),
  max(ZEMA_Kleaf_no_light$`Lowest Psileaf (Mpa)`),
  length.out = nrow(ZEMA_Kleaf_no_light))

x_filtered.ZEMA <- x_seq.ZEMA.nolight[x_seq.ZEMA.nolight <= 0.15 & x_seq.ZEMA.nolight >= 0]

# Compute the corresponding y values
y_filtered.CESE <- alpha.0.CESE * exp(beta.0.CESE * x_filtered.CESE)

y_filtered.PADI <- alpha.0.padi * exp(beta.0.padi * x_filtered.PADI)

y_filtered.AVSA <- alpha.0.AVSA * exp(beta.0.AVSA * x_filtered.AVSA)

y_filtered.DASP <- alpha.0.DASP * exp(beta.0.DASP * x_filtered.DASP)



#those that had the no light measurements
y_filtered.STDE <- alpha.0.STDE * exp(beta.0.STDE * x_filtered.STDE)
y_filtered.CHLA <- alpha.0.CHLA * exp(beta.0.CHLA * x_filtered.CHLA)
y_filtered.ZEMA <- alpha.0.ZEMA * exp(beta.0.ZEMA * x_seq.ZEMA.nolight)

# Calculate the average of Kleaf in the selected range
kmax.CESE <- mean(y_filtered.CESE)
kmax.PADI <- mean(y_filtered.PADI)
kmax.AVSA <- mean(y_filtered.AVSA)
kmax.STDE <- mean(y_filtered.STDE)
kmax.DASP <- mean(y_filtered.DASP)
kmax.CHLA <- mean(y_filtered.CHLA)
kmax.ZEMA <- mean(y_filtered.ZEMA)

kmax.AVSA
kmax.CESE
kmax.CHLA
kmax.DASP
kmax.PADI
kmax.STDE
kmax.ZEMA

```

#Kmax - second try
using actual values
```{r}
# Calculate kmax (average Kleaf for Psileaf = 0 to -0.3 MPa)
# Select x values between 0 and -0.3 MPa
filtered.CESE <- y_seq.CESE[x_seq.CESE <= 0.3 & x_seq.CESE >= 0]
filtered.PADI <- y_seq.padi[x_seq.padi <= 0.3 & x_seq.padi >= 0]
filtered.AVSA <- y_seq.AVSA[x_seq.AVSA <= 0.3 & x_seq.AVSA >= 0]
filtered.STDE <- y_seq.STDE[x_seq.STDE <= 0.3 & x_seq.STDE >= 0]
filtered.DASP <- y_seq.DASP[x_seq.DASP <= 0.3 & x_seq.DASP >= 0]
filtered.CHLA <- y_seq.CHLA[x_seq.CHLA <= 0.3 & x_seq.CHLA >= 0]
filtered.ZEMA <- ZEMA_Kleaf_clean$`Kleaf Tcorr (mmol m-2 s-1 MPa-1)`[x_seq.ZEMA <= 0.3 & x_seq.ZEMA >= 0]


# Compute the corresponding y values
y_filtered.CESE <- alpha.0.CESE * exp(beta.0.CESE * x_filtered.CESE)

y_filtered.PADI <- alpha.0.padi * exp(beta.0.padi * x_filtered.PADI)

y_filtered.AVSA <- alpha.0.AVSA * exp(beta.0.AVSA * x_filtered.AVSA)

y_filtered.STDE <- alpha.0.STDE * exp(beta.0.STDE * x_filtered.STDE)

y_filtered.DASP <- alpha.0.DASP * exp(beta.0.DASP * x_filtered.DASP)

y_filtered.CHLA <- alpha.0.CHLA * exp(beta.0.CHLA * x_filtered.CHLA)

y_filtered.ZEMA <- alpha.0.ZEMA * exp(beta.0.ZEMA * x_filtered.ZEMA)

# Calculate the average of Kleaf in the selected range
kmax.CESE <- mean(y_filtered.CESE)
kmax.PADI <- mean(y_filtered.PADI)
kmax.AVSA <- mean(y_filtered.AVSA)
kmax.STDE <- mean(y_filtered.STDE)
kmax.DASP <- mean(y_filtered.DASP)
kmax.CHLA <- mean(y_filtered.CHLA)
kmax.ZEMA <- mean(filtered.ZEMA)

kmax.AVSA
kmax.CESE
kmax.CHLA
kmax.DASP
kmax.PADI
kmax.STDE
kmax.ZEMA

```

#Package for fitting
```{r}
devtools::install_github("brownegm/hydrafit")
library(hydrafit)


```

  
